// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// User Role Enum
enum UserRole {
  USER
  ADMIN
}

// User Model
model User {
  id                String    @id @default(cuid()) @map("_id")
  email             String    @unique
  password          String
  firstName         String
  lastName          String
  phoneNumber       String?
  avatar            String?
  role              UserRole  @default(USER)
  isEmailVerified   Boolean   @default(false)
  otpCode           String?
  otpExpiresAt      DateTime?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  wallets           Wallet[]
  transactions      Transaction[]
  emotions          Emotion[]
  rewards           Reward[]
  achievements      Achievement[]
  aiInsights        AIInsight[]
  chatMessages      ChatMessage[]

  @@map("users")
}

// Wallet Model
model Wallet {
  id            String    @id @default(cuid()) @map("_id")
  userId        String
  balance       Float     @default(0)
  currency      String    @default("NPR")
  walletType    String    // "esewa", "khalti", "internal"
  walletNumber  String?   // For external wallets
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@map("wallets")
}

// Transaction Model
model Transaction {
  id            String    @id @default(cuid()) @map("_id")
  userId        String
  walletId      String
  amount        Float
  type          String    // "income", "expense", "transfer"
  category      String?   // AI-categorized
  description    String?
  paymentMethod String?   // "esewa", "khalti", "cash", "card"
  status        String    @default("pending") // "pending", "completed", "failed"
  transactionDate DateTime @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallet        Wallet    @relation(fields: [walletId], references: [id], onDelete: Cascade)
  emotion       Emotion?
  aiInsight     AIInsight?

  @@map("transactions")
}

// Emotion Model
model Emotion {
  id            String    @id @default(cuid()) @map("_id")
  userId        String
  transactionId String?   @unique
  emotionType   String    // "happy", "sad", "anxious", "excited", "neutral", "stressed"
  intensity     Int       @default(5) // 1-10 scale
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction   Transaction? @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("emotions")
}

// Reward Model
model Reward {
  id            String    @id @default(cuid()) @map("_id")
  userId        String
  rewardType    String    // "badge", "points", "streak"
  rewardName    String
  points        Int       @default(0)
  description   String?
  earnedAt      DateTime  @default(now())

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("rewards")
}

// Achievement Model
model Achievement {
  id            String    @id @default(cuid()) @map("_id")
  userId        String
  achievementType String  // "savings_milestone", "streak", "category_master", etc.
  title         String
  description   String
  icon          String?
  unlockedAt    DateTime  @default(now())

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("achievements")
}

// AI Insight Model
model AIInsight {
  id            String    @id @default(cuid()) @map("_id")
  userId        String
  transactionId String?   @unique
  insightType   String    // "prediction", "recommendation", "warning", "pattern"
  title         String
  description   String
  confidence    Float?    // 0-1 scale
  category      String?
  createdAt     DateTime  @default(now())

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction   Transaction? @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("ai_insights")
}

// Chat Message Model (for AI chatbot)
model ChatMessage {
  id            String    @id @default(cuid()) @map("_id")
  userId        String
  message       String
  response      String?
  isFromUser    Boolean   @default(true)
  createdAt     DateTime  @default(now())

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

// Payment Gateway Configuration
model PaymentGateway {
  id            String    @id @default(cuid()) @map("_id")
  gatewayName   String    @unique // "esewa", "khalti"
  apiKey        String?
  secretKey     String?
  isActive      Boolean   @default(true)
  config        Json?     // Additional gateway-specific config
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("payment_gateways")
}

